<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Imports 360 - Send Freight Queries</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    .shipment-card {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .shipment-card:hover {
        border-color: var(--accent-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .shipment-card.selected {
        border-color: var(--accent-color);
        background-color: rgba(124, 58, 237, 0.05);
    }

    .shipment-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .shipment-card-header strong {
        font-size: 16px;
        color: var(--text-primary-color);
    }

    .shipment-card-date {
        font-size: 12px;
        color: var(--text-secondary-color);
    }

    .shipment-card-body p {
        margin: 5px 0;
        font-size: 14px;
    }
</style>
</head>
<body>
  <aside class="sidebar">
     <div class="sidebar-header">
      <img src="https://i.postimg.cc/j5K3DCyc/20250826-1802-Imports-360-Logo-simple-compose-01k3k7grx1f2fsmtvdcvwbx54s.png" alt="Logo" class="sidebar-logo">
      <button class="sidebar-toggle">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li>
          <a href="admin-dashboard.html" class="nav-link">
            <i class="fas fa-home icon"></i>
            <span class="text">Dashboard</span>
          </a>
        </li>
        <li>
          <a href="documents.html" class="nav-link">
            <i class="fas fa-file-alt icon"></i>
            <span class="text">Documents</span>
          </a>
        </li>
        <li>
          <a href="forecast.html" class="nav-link">
            <i class="fas fa-bullhorn icon"></i>
            <span class="text">Forecasts</span>
          </a>
        </li>
        <li><a href="verification-list.html" class="nav-link"><i class="fas fa-check-double icon"></i><span class="text">Verification List</span></a></li>
        <li>
          <a href="#" class="nav-link has-submenu">
            <i class="fas fa-box icon"></i>
            <span class="text">Shipments</span>
            <span class="arrow"><i class="fas fa-chevron-down"></i></span>
          </a>
          <ul class="submenu">
            <li><a href="shipment_tracker.html" class="nav-link"><span class="text">Shipment Tracker</span></a></li>
            <li><a href="shipment-details.html" class="nav-link"><span class="text">All Shipments</span></a></li>
          </ul>
        </li>
        <li>
          <a href="product-details.html" class="nav-link">
            <i class="fas fa-tags icon"></i>
            <span class="text">Products</span>
          </a>
        </li>
        <li>
          <a href="supplier-details.html" class="nav-link">
            <i class="fas fa-truck icon"></i>
            <span class="text">Suppliers</span>
          </a>
        </li>
        <li>
          <a href="supplier-shipment-responses.html" class="nav-link">
            <i class="fas fa-inbox icon"></i>
            <span class="text">Supplier Responses</span>
          </a>
        </li>
        <li>
          <a href="bank-details.html" class="nav-link">
            <i class="fas fa-university icon"></i>
            <span class="text">Banks</span>
          </a>
        </li>
        <li>
          <a href="clearing-agent-details.html" class="nav-link">
            <i class="fas fa-user-shield icon"></i>
            <span class="text">Clearing Agents</span>
          </a>
        </li>
        <li>
          <a href="warehouse-details.html" class="nav-link">
            <i class="fas fa-warehouse icon"></i>
            <span class="text">Warehouses</span>
          </a>
        </li>
        <li><a href="logistic-cells.html" class="nav-link"><i class="fas fa-cubes icon"></i><span class="text">Logistic Cells</span></a></li>
        <li>
          <a href="#" class="nav-link has-submenu open">
            <i class="fas fa-truck-ramp-box icon"></i>
            <span class="text">Freight</span>
            <span class="arrow"><i class="fas fa-chevron-down"></i></span>
          </a>
          <ul class="submenu open">
            <li><a href="send-freight-queries.html" class="nav-link active"><span class="text">Send Freight Queries</span></a></li>
            <li><a href="freight-query-response.html" class="nav-link"><span class="text">Freight Query Response</span></a></li>
            <li><a href="manage-freight-queries.html" class="nav-link"><span class="text">Manage Freight Queries</span></a></li>
            <li><a href="award-shipment.html" class="nav-link"><span class="text">Award Shipment</span></a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </aside>

  <div class="main-content">
    <header class="main-header">
      <div class="header-title">
        <button class="back-button" onclick="window.history.back();"><i class="fas fa-arrow-left"></i></button>
        <h1>Send Freight Queries</h1>
      </div>
    </header>
    <div class="stepper">
      <div class="step active" data-step="1">
        <div class="step-icon">1</div>
        <div class="step-label">Select Shipment</div>
      </div>
      <div class="step-connector"></div>
      <div class="step" data-step="2">
        <div class="step-icon">2</div>
        <div class="step-label">Select Companies</div>
      </div>
      <div class="step-connector"></div>
      <div class="step" data-step="3">
        <div class="step-icon">3</div>
        <div class="step-label">Send Queries</div>
      </div>
    </div>
    <div id="message" class="message-container"></div>
    <div class="send-queries-container">
      <div class="shipment-selection-panel">
        <div class="panel-header">
          <h2>1. Select a Shipment</h2>
          <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="shipment-search" placeholder="Search shipments...">
          </div>
        </div>
        <div class="panel-body">
          <div id="shipments-list" class="shipments-list">
            <p>Loading shipments...</p>
          </div>
        </div>
      </div>

      <div class="company-selection-panel">
        <div class="panel-header">
          <h2>2. Select Logistics Companies</h2>
          <button id="select-all-btn" class="button-secondary">Select All</button>
        </div>
        <div class="panel-body">
          <div id="logistics-companies-list" class="companies-list">
            <p>Loading companies...</p>
          </div>
          <div class="button-container">
            <button id="next-btn" class="button">Next</button>
          </div>
        </div>
      </div>

      <div class="summary-panel">
        <div class="panel-header">
          <h2>Summary</h2>
        </div>
        <div class="panel-body">
          <div id="summary-shipment">
            <p>No shipment selected.</p>
          </div>
          <hr>
          <div id="summary-companies">
            <p>No companies selected.</p>
          </div>
          <div class="button-container">
            <button id="send-queries-btn" class="button" disabled>Send Queries</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2.43.4";
  const supabase = createClient("https://sfknzqkiqxivzcualcau.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNma256cWtpcXhpdnpjdWFsY2F1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTU0ODksImV4cCI6MjA3MjM3MTQ4OX0.JKjOS9NRdbVH1UanfqmBeHmMSnlWlZtDr-5LdKw5YaA");

  let allShipments = [];
  let allCompanies = [];
  let selectedShipmentId = null;
  let selectedCompanyIds = new Set();
  let currentStep = 1;

  function goToStep(step) {
    currentStep = step;
    document.querySelectorAll('.step').forEach(stepEl => {
      stepEl.classList.toggle('active', parseInt(stepEl.dataset.step) === currentStep);
    });

    document.querySelector('.shipment-selection-panel').style.display = currentStep === 1 ? 'block' : 'none';
    document.querySelector('.company-selection-panel').style.display = currentStep === 2 ? 'block' : 'none';
    document.querySelector('.summary-panel').style.display = currentStep === 3 ? 'block' : 'none';
  }

  function showMessage(message, isError = false) {
    const messageDiv = document.getElementById('message');
    messageDiv.innerHTML = `<p class="${isError ? 'error-message' : 'success-message'}">${message}</p>`;
    window.scrollTo(0, 0);
  }

  function renderShipments(shipments) {
    const shipmentsListDiv = document.getElementById('shipments-list');
    if (shipments.length === 0) {
      shipmentsListDiv.innerHTML = '<p>No shipments found.</p>';
      return;
    }
    shipmentsListDiv.innerHTML = '';
    shipments.forEach(s => {
      const card = document.createElement('div');
      card.className = 'shipment-card';
      card.dataset.id = s.id;
      card.innerHTML = `
        <div class="shipment-card-header">
          <strong>${s.reference_code}</strong>
          <span class="shipment-card-date">${new Date(s.created_at).toLocaleDateString()}</span>
        </div>
        <div class="shipment-card-body">
          <p><strong>Product:</strong> ${s.product_name || 'N/A'} - ${s.variety_name || 'N/A'}</p>
          <p><strong>Stage:</strong> ${s.current_stage}</p>
        </div>
      `;
      card.addEventListener('click', () => selectShipment(s.id));
      shipmentsListDiv.appendChild(card);
    });
  }

  function renderCompanies(companies) {
    const companiesListDiv = document.getElementById('logistics-companies-list');
    if (companies.length === 0) {
      companiesListDiv.innerHTML = '<p>No companies found.</p>';
      return;
    }
    companiesListDiv.innerHTML = '';
    companies.forEach(c => {
      const card = document.createElement('div');
      card.className = 'company-card';
      card.dataset.id = c.id;
      card.innerHTML = `
        <strong>${c.name}</strong>
        <p>${c.contact_email || 'No email'}</p>
      `;
      card.addEventListener('click', () => toggleCompanySelection(c.id));
      companiesListDiv.appendChild(card);
    });
  }

  async function loadPageData() {
    const { data: shipments, error: shipmentError } = await supabase
      .from('v_shipments_with_details')
      .select('id, reference_code, product_name, variety_name, created_at, current_stage');

    if (shipmentError) {
      console.error(shipmentError);
      return;
    }
    allShipments = shipments;
    renderShipments(allShipments);

    const { data: companies, error: companyError } = await supabase
      .from('logistics_company')
      .select('id, name, contact_email');

    if (companyError) {
      console.error(companyError);
      return;
    }
    allCompanies = companies;
    renderCompanies(allCompanies);
  }

  function selectShipment(shipmentId) {
    selectedShipmentId = shipmentId;
    document.querySelectorAll('.shipment-card').forEach(card => {
      card.classList.toggle('selected', card.dataset.id === shipmentId);
    });
    updateSummary();
    goToStep(2);
  }

  function toggleCompanySelection(companyId) {
    const card = document.querySelector(`.company-card[data-id="${companyId}"]`);
    if (selectedCompanyIds.has(companyId)) {
      selectedCompanyIds.delete(companyId);
      card.classList.remove('selected');
    } else {
      selectedCompanyIds.add(companyId);
      card.classList.add('selected');
    }
    updateSummary();
  }

  function updateSummary() {
    const shipmentSummaryDiv = document.getElementById('summary-shipment');
    if (selectedShipmentId) {
      const shipment = allShipments.find(s => s.id === selectedShipmentId);
      shipmentSummaryDiv.innerHTML = `<p><strong>Shipment:</strong> ${shipment.reference_code}</p>`;
    } else {
      shipmentSummaryDiv.innerHTML = '<p>No shipment selected.</p>';
    }

    const companySummaryDiv = document.getElementById('summary-companies');
    companySummaryDiv.innerHTML = `<p>${selectedCompanyIds.size} companies selected.</p>`;

    document.getElementById('send-queries-btn').disabled = !selectedShipmentId || selectedCompanyIds.size === 0;
  }

  async function sendQueries() {
    const sendButton = document.getElementById('send-queries-btn');
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    const queriesToInsert = Array.from(selectedCompanyIds).map(companyId => ({
      shipment_id: selectedShipmentId,
      logistics_company_id: companyId,
    }));

    const { data: newQueries, error } = await supabase
      .from('freight_query')
      .insert(queriesToInsert)
      .select();

    if (error) {
      showMessage(`Error creating freight queries: ${error.message}`, true);
      sendButton.disabled = false;
      sendButton.innerHTML = 'Send Queries';
      return;
    }

    const emailPromises = newQueries.map(newQuery => {
      const company = allCompanies.find(c => c.id === newQuery.logistics_company_id);
      if (company && company.contact_email) {
        const quoteUrl = `${window.location.origin}/quote-submission.html?freight_query_id=${newQuery.id}`;
        return supabase.functions.invoke('send-freight-query-email', {
          body: { 
            email: company.contact_email,
            quote_url: quoteUrl
          }
        }).then(({ error }) => {
          if (error) {
            throw { companyName: company.name, error };
          }
          return { companyName: company.name, success: true };
        });
      }
      return Promise.resolve({ companyName: company ? company.name : 'Unknown', success: false, error: 'No contact email' });
    });

    const results = await Promise.allSettled(emailPromises);

    let allEmailsSent = true;
    results.forEach(result => {
      if (result.status === 'rejected') {
        allEmailsSent = false;
        showMessage(`Failed to send email to ${result.reason.companyName}: ${result.reason.error.message}`, true);
        console.error(`Failed to send email to ${result.reason.companyName}:`, result.reason.error);
      } else if (result.value.success) {
        showMessage(`Successfully sent email to ${result.value.companyName}.`);
      }
    });

    if(allEmailsSent) {
        showMessage('All freight queries sent successfully!');
    } else {
        showMessage('Some freight queries were sent, but there were errors sending one or more emails. Please check the console for details.', true);
    }
    
    sendButton.disabled = false;
    sendButton.innerHTML = 'Send Queries';
  }

  window.onload = () => {
    loadPageData();

    document.getElementById('shipment-search').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filteredShipments = allShipments.filter(s => s.reference_code.toLowerCase().includes(searchTerm));
      renderShipments(filteredShipments);
    });

    document.getElementById('select-all-btn').addEventListener('click', () => {
      const allCompanyIds = allCompanies.map(c => c.id);
      const allSelected = allCompanyIds.every(id => selectedCompanyIds.has(id));
      
      allCompanies.forEach(c => {
        if (allSelected) {
          selectedCompanyIds.delete(c.id);
        } else {
          selectedCompanyIds.add(c.id);
        }
      });

      document.querySelectorAll('.company-card').forEach(card => {
        card.classList.toggle('selected', !allSelected);
      });

      updateSummary();
    });

    document.getElementById('send-queries-btn').addEventListener('click', sendQueries);
    document.getElementById('next-btn').addEventListener('click', () => goToStep(3));

    goToStep(1);
  };

</script>
</body>
</html>
