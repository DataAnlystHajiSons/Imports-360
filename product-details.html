<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Product Details</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/+esm";
  const supabase = createClient("https://sfknzqkiqxivzcualcau.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNma256cWtpcXhpdnpjdWFsY2F1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTU0ODksImV4cCI6MjA3MjM3MTQ4OX0.JKjOS9NRdbVH1UanfqmBeHmMSnlWlZtDr-5LdKw5YaA");

  // Searchable Dropdown Implementation
  function createSearchableDropdown(selectElement, options, placeholder = 'Select an option') {
    const container = document.createElement('div');
    container.className = 'searchable-dropdown';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'dropdown-input';
    input.placeholder = placeholder;
    input.readOnly = true;
    
    const dropdownList = document.createElement('div');
    dropdownList.className = 'dropdown-list';
    
    container.appendChild(input);
    container.appendChild(dropdownList);
    
    // Replace the original select element
    selectElement.style.display = 'none';
    selectElement.parentNode.insertBefore(container, selectElement);
    
    let filteredOptions = [...options];
    let allOptions = [...options];
    
    function renderOptions() {
      dropdownList.innerHTML = '';
      
      if (filteredOptions.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = 'No results found';
        dropdownList.appendChild(noResults);
        return;
      }
      
      filteredOptions.forEach(option => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.textContent = option.text;
        item.dataset.value = option.value;
        
        if (option.value === selectElement.value) {
          item.classList.add('selected');
        }
        
        item.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          selectElement.value = option.value;
          input.value = option.text;
          container.classList.remove('active');
          input.readOnly = true;
          
          // Remove selected and highlighted classes from all items
          dropdownList.querySelectorAll('.dropdown-item').forEach(el => {
            el.classList.remove('selected', 'highlighted');
          });
          item.classList.add('selected');
          
          // Trigger change event on original select
          const event = new Event('change', { bubbles: true });
          selectElement.dispatchEvent(event);
        });
        
        dropdownList.appendChild(item);
      });
    }
    
    function filterOptions(searchTerm) {
      const term = searchTerm.toLowerCase().trim();
      if (term === '') {
        filteredOptions = [...allOptions];
      } else {
        filteredOptions = allOptions.filter(option => 
          option.text.toLowerCase().includes(term)
        );
      }
      renderOptions();
    }
    
    // Set initial value if select has a value
    const initialSelectedOption = allOptions.find(opt => opt.value === selectElement.value);
    if (initialSelectedOption) {
      input.value = initialSelectedOption.text;
    } else if (allOptions.length > 0 && allOptions[0].value === '') {
      input.value = allOptions[0].text;
    }
    
    // Input events
    input.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      if (input.readOnly) {
        input.readOnly = false;
        input.value = '';
        container.classList.add('active');
        input.focus();
        filterOptions('');
      }
    });
    
    input.addEventListener('input', (e) => {
      if (!input.readOnly) {
        filterOptions(e.target.value);
      }
    });
    
    // Handle clicks outside to close dropdown
    document.addEventListener('click', (e) => {
      if (!container.contains(e.target)) {
        container.classList.remove('active');
        input.readOnly = true;
        
        // Reset input value to selected option or placeholder
        const selectedOption = allOptions.find(opt => opt.value === selectElement.value);
        if (selectedOption) {
          input.value = selectedOption.text;
        } else {
          input.value = allOptions[0]?.text || '';
        }
        
        // Remove highlighted items
        dropdownList.querySelectorAll('.dropdown-item').forEach(el => {
          el.classList.remove('highlighted');
        });
      }
    });
    
    // Add keyboard navigation
    input.addEventListener('keydown', (e) => {
      if (!container.classList.contains('active')) return;
      
      const items = dropdownList.querySelectorAll('.dropdown-item:not(.no-results)');
      const currentSelected = dropdownList.querySelector('.dropdown-item.highlighted');
      let currentIndex = currentSelected ? Array.from(items).indexOf(currentSelected) : -1;
      
      switch(e.key) {
        case 'ArrowDown':
          e.preventDefault();
          if (currentSelected) currentSelected.classList.remove('highlighted');
          currentIndex = (currentIndex + 1) % items.length;
          if (items[currentIndex]) items[currentIndex].classList.add('highlighted');
          break;
        case 'ArrowUp':
          e.preventDefault();
          if (currentSelected) currentSelected.classList.remove('highlighted');
          currentIndex = currentIndex <= 0 ? items.length - 1 : currentIndex - 1;
          if (items[currentIndex]) items[currentIndex].classList.add('highlighted');
          break;
        case 'Enter':
          e.preventDefault();
          if (currentSelected) {
            currentSelected.click();
          }
          break;
        case 'Escape':
          e.preventDefault();
          container.classList.remove('active');
          input.readOnly = true;
          const selectedOption = allOptions.find(opt => opt.value === selectElement.value);
          if (selectedOption) {
            input.value = selectedOption.text;
          } else {
            input.value = allOptions[0]?.text || '';
          }
          break;
      }
    });
    
    // Initialize
    renderOptions();
    
    return {
      updateOptions: (newOptions) => {
        allOptions = [...newOptions];
        filteredOptions = [...newOptions];
        renderOptions();
        
        // Update input value if needed
        const selectedOption = allOptions.find(opt => opt.value === selectElement.value);
        if (selectedOption) {
          input.value = selectedOption.text;
        } else if (allOptions.length > 0) {
          input.value = allOptions[0].text;
        }
      },
      container,
      selectElement
    };
  }

  async function loadProducts(filters = {}) {
    let query = supabase
      .from("product_variety")
      .select(`
        *,
        supplier (name),
        commodity:commodity_id (name)
      `);

    if (filters.product_name) {
      query = query.ilike('product_name', `%${filters.product_name}%`);
    }
    if (filters.supplier_id) {
      query = query.eq('supplier_id', filters.supplier_id);
    }
    if (filters.commodity_id) {
      query = query.eq('commodity_id', filters.commodity_id);
    }

    const { data, error } = await query;

    if (error) {
      document.getElementById("products-list").innerHTML = `<p class="error-message">Error loading products: ${error.message}</p>`;
      return;
    }

    let html = "<table><tr><th>Product Name</th><th>Variety Name</th><th>Commodity</th><th>Supplier</th><th>Unit</th><th>Rate Per Unit</th><th>Actions</th></tr>";
    data.forEach(item => {
      html += `<tr>
        <td>${item.product_name}</td>
        <td>${item.variety_name}</td>
        <td>${item.commodity ? item.commodity.name : ''}</td>
        <td>${item.supplier ? item.supplier.name : ''}</td>
        <td>${item.unit}</td>
        <td>${item.rate_per_unit}</td>
        <td class="action-cell">
          <button class="button-secondary" onclick='openEditProductModal(${JSON.stringify(item)})'>Edit</button>
          <button class="button-secondary" onclick='deleteProduct("${item.id}")'>Delete</button>
        </td>
      </tr>`;
    });
    html += "</table>";

    document.getElementById("products-list").innerHTML = html;
  }

  async function openEditProductModal(product) {
    await openNewProductModal(product);
  }

  async function deleteProduct(id) {
    if (!confirm('Are you sure you want to delete this product?')) {
      return;
    }

    const { error } = await supabase.from('product_variety').delete().eq('id', id);

    if (error) {
      alert(`Error deleting product: ${error.message}`);
    } else {
      loadProducts();
    }
  }

  async function populateUnits(commodityId, selectedUnit = null) {
    const unitSelect = document.getElementById('unit');
    unitSelect.innerHTML = '';
    if (commodityId) {
        const { data, error } = await supabase
            .from('measurement_unit')
            .select('unit_name')
            .eq('commodity_id', commodityId);
        if (error) {
            console.error('Error loading measurement units:', error);
        } else {
            data.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.unit_name;
                option.textContent = unit.unit_name;
                unitSelect.appendChild(option);
            });
            if (selectedUnit) {
                unitSelect.value = selectedUnit;
            }
        }
    }
  }

  let activeUnitSelect = null;
  let activeCommodityIdForUnit = null;

  async function openAddUnitModal(unitSelectElement, commodityId) {
    activeUnitSelect = unitSelectElement;
    activeCommodityIdForUnit = commodityId;
    document.getElementById('add-unit-modal').style.display = 'block';
  }

  function closeAddUnitModal() {
    document.getElementById('add-unit-modal').style.display = 'none';
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('add-unit-form').addEventListener('submit', async (event) => {
      event.preventDefault();
      const newUnitName = document.getElementById('new_unit_name').value;
      const messageDiv = document.getElementById('add-unit-message');

      if (!activeCommodityIdForUnit) {
        messageDiv.innerHTML = '<p class="error-message">Please select a commodity first.</p>';
        return;
      }

      const { data, error } = await supabase.from('measurement_unit').insert({ unit_name: newUnitName, commodity_id: activeCommodityIdForUnit }).select().single();

      if (error) {
        messageDiv.innerHTML = `<p class="error-message">Error adding unit: ${error.message}</p>`;
      } else {
        messageDiv.innerHTML = `<p class="success-message">Unit added successfully!</p>`;
        document.getElementById('add-unit-form').reset();
        closeAddUnitModal();
        
        if (activeUnitSelect) {
          const option = document.createElement('option');
          option.value = data.unit_name;
          option.textContent = data.unit_name;
          option.selected = true;
          activeUnitSelect.appendChild(option);
        }
      }
    });

    document.getElementById('close-add-unit-modal-btn').addEventListener('click', closeAddUnitModal);
  });

  async function openNewProductModal(product = null) {
    let formHtml = '<div id="new-product-message"></div>';
    formHtml += '<form id="new-product-form">';
    formHtml += '<input type="hidden" id="product_id" name="product_id">';
    formHtml += '<div><label for="product_name">Product Name:</label><input type="text" id="product_name" name="product_name"></div>';
    formHtml += '<div><label for="variety_name">Variety Name:</label><input type="text" id="variety_name" name="variety_name"></div>';
    formHtml += '<div><label for="commodity_id">Commodity:</label><select id="commodity_id" name="commodity_id"></select></div>';
    formHtml += '<div><label for="unit">Unit:</label><div class="input-group"><select id="unit" name="unit"></select><button type="button" class="add-new-btn">+</button></div></div>';
    formHtml += '<div><label for="rate_per_unit">Rate Per Unit:</label><input type="number" id="rate_per_unit" name="rate_per_unit"></div>';
    formHtml += '<div><label for="supplier_id">Supplier:</label><select id="supplier_id" name="supplier_id"></select></div>';
    formHtml += '<button type="button" onclick="saveNewProduct()">Save</button>';
    formHtml += '</form>';

    const productFormContainer = document.getElementById('new-product-form-container');
    productFormContainer.innerHTML = formHtml;

    const commoditySelect = document.getElementById('commodity_id');
    const unitSelect = document.getElementById('unit');
    const supplierSelect = document.getElementById('supplier_id');
    const addNewUnitBtn = productFormContainer.querySelector('.add-new-btn');

    if (addNewUnitBtn) {
      addNewUnitBtn.addEventListener('click', () => {
        const commodityId = commoditySelect.value;
        openAddUnitModal(unitSelect, commodityId);
      });
    }

    // Load and create searchable commodity dropdown
    const { data: commodities, error: commoditiesError } = await supabase.from('commodity').select('id, name');
    if (commoditiesError) {
        console.error("Error loading commodities:", commoditiesError);
        return;
    }
    
    commoditySelect.innerHTML = '<option value="">Select Commodity</option>';
    const commodityOptions = [
      { value: '', text: 'Select Commodity' },
      ...commodities.map(item => ({
        value: item.id,
        text: item.name
      }))
    ];
    
    // Add options to original select
    commodities.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        commoditySelect.appendChild(option);
    });
    
    // Create searchable dropdown for commodity
    const commodityDropdown = createSearchableDropdown(commoditySelect, commodityOptions, 'Search commodities...');

    commoditySelect.addEventListener('change', async (e) => {
        await populateUnitsSearchable(e.target.value);
    });

    // Load and create searchable supplier dropdown
    const { data: suppliers, error: suppliersError } = await supabase.from('supplier').select('id, name');
    if (suppliersError) {
        console.error("Error loading suppliers:", suppliersError);
        return;
    }

    supplierSelect.innerHTML = '<option value="">Select Supplier</option>';
    const supplierOptions = [
      { value: '', text: 'Select Supplier' },
      ...suppliers.map(item => ({
        value: item.id,
        text: item.name
      }))
    ];
    
    // Add options to original select
    suppliers.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        supplierSelect.appendChild(option);
    });
    
    // Create searchable dropdown for supplier
    const supplierDropdown = createSearchableDropdown(supplierSelect, supplierOptions, 'Search suppliers...');

    // Function to populate units with searchable dropdown
    async function populateUnitsSearchable(commodityId, selectedUnit = null) {
      const unitSelect = document.getElementById('unit');
      
      // Remove existing searchable dropdown if it exists
      const existingUnitDropdown = unitSelect.previousElementSibling;
      if (existingUnitDropdown && existingUnitDropdown.classList.contains('searchable-dropdown')) {
        existingUnitDropdown.remove();
        unitSelect.style.display = '';
      }
      
      unitSelect.innerHTML = '';
      
      if (commodityId) {
          const { data, error } = await supabase
              .from('measurement_unit')
              .select('unit_name')
              .eq('commodity_id', commodityId);
          if (error) {
              console.error('Error loading measurement units:', error);
          } else {
              const unitOptions = [
                { value: '', text: 'Select Unit' },
                ...data.map(unit => ({
                  value: unit.unit_name,
                  text: unit.unit_name
                }))
              ];
              
              // Add options to original select
              data.forEach(unit => {
                  const option = document.createElement('option');
                  option.value = unit.unit_name;
                  option.textContent = unit.unit_name;
                  unitSelect.appendChild(option);
              });
              
              // Create searchable dropdown for units
              createSearchableDropdown(unitSelect, unitOptions, 'Search units...');
              
              if (selectedUnit) {
                  unitSelect.value = selectedUnit;
                  // Update the searchable dropdown input display
                  const selectedUnitOption = unitOptions.find(opt => opt.value === selectedUnit);
                  if (selectedUnitOption) {
                    const unitDropdownContainer = unitSelect.previousElementSibling;
                    if (unitDropdownContainer && unitDropdownContainer.classList.contains('searchable-dropdown')) {
                      const unitInput = unitDropdownContainer.querySelector('.dropdown-input');
                      if (unitInput) unitInput.value = selectedUnitOption.text;
                    }
                  }
              }
          }
      }
    }

    if (product) {
        document.getElementById('product_id').value = product.id;
        document.getElementById('product_name').value = product.product_name;
        document.getElementById('variety_name').value = product.variety_name;
        commoditySelect.value = product.commodity_id;
        
        // Update commodity dropdown display
        const selectedCommodity = commodityOptions.find(opt => opt.value === product.commodity_id);
        if (selectedCommodity && commodityDropdown.container) {
          const commodityInput = commodityDropdown.container.querySelector('.dropdown-input');
          if (commodityInput) commodityInput.value = selectedCommodity.text;
        }
        
        await populateUnitsSearchable(product.commodity_id, product.unit);

        document.getElementById('rate_per_unit').value = product.rate_per_unit;
        supplierSelect.value = product.supplier_id;
        
        // Update supplier dropdown display
        const selectedSupplier = supplierOptions.find(opt => opt.value === product.supplier_id);
        if (selectedSupplier && supplierDropdown.container) {
          const supplierInput = supplierDropdown.container.querySelector('.dropdown-input');
          if (supplierInput) supplierInput.value = selectedSupplier.text;
        }
    }

    document.getElementById('new-product-modal').style.display = 'block';
  }

  function closeModal() {
    document.getElementById('new-product-modal').style.display = 'none';
  }

  async function saveNewProduct() {
    const form = document.getElementById('new-product-form');
    const formData = new FormData(form);
    const productId = formData.get('product_id');

    let rate_per_unit = formData.get('rate_per_unit');
    if (rate_per_unit === '') {
        rate_per_unit = null;
    }

    const productData = {
        product_name: formData.get('product_name'),
        variety_name: formData.get('variety_name'),
        commodity_id: formData.get('commodity_id'),
        supplier_id: formData.get('supplier_id'),
        unit: formData.get('unit'),
        rate_per_unit: rate_per_unit
    };

    let query;
    if (productId) {
        query = supabase.from('product_variety').update(productData).eq('id', productId);
    } else {
        query = supabase.from('product_variety').insert(productData);
    }

    const { error } = await query;

    if (error) {
        document.getElementById('new-product-message').innerHTML = `<p class="error-message">Error creating product: ${error.message}</p>`;
    } else {
        closeModal();
        loadProducts();
    }
  }

  window.openNewProductModal = openNewProductModal;
  window.openEditProductModal = openEditProductModal;
  window.deleteProduct = deleteProduct;
  window.saveNewProduct = saveNewProduct;
  window.closeModal = closeModal;

  async function loadFilters() {
    const { data: suppliers, error: supplierError } = await supabase.from('supplier').select('id, name');
    if (supplierError) console.error('Error loading suppliers:', supplierError);
    else {
      const select = document.getElementById('supplier-filter');
      select.innerHTML = '<option value="">All Suppliers</option>';
      
      const supplierOptions = [
        { value: '', text: 'All Suppliers' },
        ...suppliers.map(item => ({
          value: item.id,
          text: item.name
        }))
      ];
      
      // Add options to original select
      suppliers.forEach(item => {
        select.innerHTML += `<option value="${item.id}">${item.name}</option>`;
      });
      
      // Create searchable dropdown
      createSearchableDropdown(select, supplierOptions, 'Search suppliers...');
    }

    const { data: commodities, error: commodityError } = await supabase.from('commodity').select('id, name');
    if (commodityError) console.error('Error loading commodities:', commodityError);
    else {
      const select = document.getElementById('commodity-filter');
      select.innerHTML = '<option value="">All Commodities</option>';
      
      const commodityOptions = [
        { value: '', text: 'All Commodities' },
        ...commodities.map(item => ({
          value: item.id,
          text: item.name
        }))
      ];
      
      // Add options to original select
      commodities.forEach(item => {
        select.innerHTML += `<option value="${item.id}">${item.name}</option>`;
      });
      
      // Create searchable dropdown
      createSearchableDropdown(select, commodityOptions, 'Search commodities...');
    }
  }

  function updateFilterBadge() {
    const filters = {
        product_name: document.getElementById('product-name-filter').value,
        supplier_id: document.getElementById('supplier-filter').value,
        commodity_id: document.getElementById('commodity-filter').value
    };
    const activeFilters = Object.values(filters).filter(v => v !== '' && v !== null).length;
    const badge = document.getElementById('filter-count-badge');
    if (activeFilters > 0) {
      badge.textContent = activeFilters;
      badge.style.display = 'inline';
    } else {
      badge.style.display = 'none';
    }
  }

  window.onload = async () => {
      const loader = document.getElementById("loader");
      if (loader) {
          loader.style.display = "block";
      }

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
          window.location.href = 'login.html';
      } else {
          await loadProducts();
          await loadFilters();
      }

      if (loader) {
          loader.style.display = "none";
      }

      document.getElementById('filter-toggle-btn').addEventListener('click', () => {
        const filterPane = document.getElementById('filter-pane');
        const toggleBtn = document.getElementById('filter-toggle-btn');
        
        if (filterPane.classList.contains('open')) {
          filterPane.classList.remove('open');
          toggleBtn.classList.remove('active');
        } else {
          filterPane.classList.add('open');
          toggleBtn.classList.add('active');
        }
      });

      document.getElementById('apply-filters-btn').addEventListener('click', () => {
        const filters = {
            product_name: document.getElementById('product-name-filter').value || null,
            supplier_id: document.getElementById('supplier-filter').value || null,
            commodity_id: document.getElementById('commodity-filter').value || null
        };
        loadProducts(filters);
        updateFilterBadge();
      });

      document.getElementById('clear-filters-btn').addEventListener('click', () => {
        document.getElementById('product-name-filter').value = '';
        document.getElementById('supplier-filter').value = '';
        document.getElementById('commodity-filter').value = '';
        
        // Clear searchable dropdown inputs
        const supplierDropdownInput = document.querySelector('#supplier-filter').previousElementSibling?.querySelector('.dropdown-input');
        if (supplierDropdownInput) {
          supplierDropdownInput.value = 'All Suppliers';
          supplierDropdownInput.readOnly = true;
        }
        
        const commodityDropdownInput = document.querySelector('#commodity-filter').previousElementSibling?.querySelector('.dropdown-input');
        if (commodityDropdownInput) {
          commodityDropdownInput.value = 'All Commodities';
          commodityDropdownInput.readOnly = true;
        }
        
        loadProducts();
        updateFilterBadge();
      });
  };
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div class="loader-overlay" id="loader">
    <div class="loader">
      <div class="loader-dot"></div>
      <div class="loader-dot"></div>
      <div class="loader-dot"></div>
    </div>
  </div>
  <aside class="sidebar">
     <div class="sidebar-header">
      <img src="https://i.postimg.cc/j5K3DCyc/20250826-1802-Imports-360-Logo-simple-compose-01k3k7grx1f2fsmtvdcvwbx54s.png" alt="Logo" class="sidebar-logo">
      <button class="sidebar-toggle">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li>
          <a href="admin-dashboard.html" class="nav-link active">
            <i class="fas fa-home icon"></i>
            <span class="text">Dashboard</span>
          </a>
        </li>
        <li>
          <a href="documents.html" class="nav-link">
            <i class="fas fa-file-alt icon"></i>
            <span class="text">Documents</span>
          </a>
        </li>
        <li>
          <a href="forecast.html" class="nav-link">
            <i class="fas fa-bullhorn icon"></i>
            <span class="text">Forecasts</span>
          </a>
        </li>
        <li><a href="verification-list.html" class="nav-link"><i class="fas fa-check-double icon"></i><span class="text">Verification List</span></a></li>
        <li>
          <a href="#" class="nav-link has-submenu">
            <i class="fas fa-box icon"></i>
            <span class="text">Shipments</span>
            <span class="arrow"><i class="fas fa-chevron-down"></i></span>
          </a>
          <ul class="submenu">
            <li><a href="shipment_tracker.html" class="nav-link"><span class="text">Shipment Tracker</span></a></li>
            <li><a href="shipment-details.html" class="nav-link"><span class="text">All Shipments</span></a></li>
          </ul>
        </li>
        <li>
          <a href="product-details.html" class="nav-link">
            <i class="fas fa-tags icon"></i>
            <span class="text">Products</span>
          </a>
        </li>
        <li>
          <a href="supplier-details.html" class="nav-link">
            <i class="fas fa-truck icon"></i>
            <span class="text">Suppliers</span>
          </a>
        </li>
        <li>
          <a href="supplier-shipment-responses.html" class="nav-link">
            <i class="fas fa-inbox icon"></i>
            <span class="text">Supplier Responses</span>
          </a>
        </li>
        <li>
          <a href="bank-details.html" class="nav-link">
            <i class="fas fa-university icon"></i>
            <span class="text">Banks</span>
          </a>
        </li>
        <li>
          <a href="clearing-agent-details.html" class="nav-link">
            <i class="fas fa-user-shield icon"></i>
            <span class="text">Clearing Agents</span>
          </a>
        </li>
        <li>
          <a href="warehouse-details.html" class="nav-link">
            <i class="fas fa-warehouse icon"></i>
            <span class="text">Warehouses</span>
          </a>
        </li>
        <li><a href="logistic-cells.html" class="nav-link"><i class="fas fa-cubes icon"></i><span class="text">Logistic Cells</span></a></li>
        <li>
          <a href="#" class="nav-link has-submenu">
            <i class="fas fa-truck-ramp-box icon"></i>
            <span class="text">Freight</span>
            <span class="arrow"><i class="fas fa-chevron-down"></i></span>
          </a>
          <ul class="submenu open">
            <li><a href="send-freight-queries.html" class="nav-link"><span class="text">Send Freight Queries</span></a></li>
            <li><a href="freight-query-response.html" class="nav-link"><span class="text">Freight Query Response</span></a></li>
            <li><a href="manage-freight-queries.html" class="nav-link"><span class="text">Manage Freight Queries</span></a></li>
            <li><a href="award-shipment.html" class="nav-link"><span class="text">Award Shipment</span></a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </aside>

  <div class="main-content">
    <header class="main-header">
      <div class="header-title">
        <button class="back-button" onclick="window.history.back();"><i class="fas fa-arrow-left"></i></button>
        <h1>Products</h1>
      </div>
      <div>
        <button id="filter-toggle-btn" class="button button-secondary">
          <i class="fas fa-filter"></i>
          <span>Filters</span>
          <span id="filter-count-badge" class="badge" style="display: none;"></span>
        </button>
        <button onclick="openNewProductModal()">Create New Product</button>
      </div>
    </header>
    <div class="panel">
      <div id="filter-pane" class="filter-pane">
        <div class="filter-group">
          <label for="product-name-filter">Product Name</label>
          <input type="text" id="product-name-filter" placeholder="Enter product name">
        </div>
        <div class="filter-group">
          <label for="supplier-filter">Supplier</label>
          <select id="supplier-filter"></select>
        </div>
        <div class="filter-group">
          <label for="commodity-filter">Commodity</label>
          <select id="commodity-filter"></select>
        </div>
        <div class="button-container">
          <button id="apply-filters-btn" class="button">Apply</button>
          <button id="clear-filters-btn" class="button button-secondary">Clear</button>
        </div>
      </div>
      <div class="panel-body">
        <div id="products-list" class="table-container">Loading...</div>
      </div>
    </div>

    <p class="back-link"><a href="admin-dashboard.html">← Back to Dashboard</a></p>

    <div id="new-product-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <h2>Create New Product</h2>
        <div id="new-product-form-container"></div>
      </div>
    </div>
  </div>

<div id="add-unit-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close-button" id="close-add-unit-modal-btn">&times;</span>
    <h2>Add New Unit</h2>
    <div id="add-unit-message"></div>
    <form id="add-unit-form">
      <div>
        <label for="new_unit_name">Unit Name:</label>
        <input type="text" id="new_unit_name" name="new_unit_name" required>
      </div>
      <button type="submit">Save Unit</button>
    </form>
  </div>
</div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.querySelector('.sidebar');
      const sidebarToggle = document.querySelector('.sidebar-toggle');
      const navLinks = document.querySelectorAll('.nav-link');
      const hasSubmenus = document.querySelectorAll('.has-submenu');

      // Responsive off-canvas menu (for mobile)
      const mediaQuery = window.matchMedia('(max-width: 768px)');

      function handleMediaQueryChange(e) {
        if (e.matches) { // If on mobile
          sidebar.classList.remove('collapsed'); // Ensure it's not collapsed on mobile
          sidebar.classList.remove('open'); // Ensure it's closed initially on mobile
        } else { // If on desktop
          sidebar.classList.remove('open'); // Ensure it's not open on desktop
        }
      }

      // Initial check for mobile responsiveness
      handleMediaQueryChange(mediaQuery);

      // Listen for changes in media query
      mediaQuery.addListener(handleMediaQueryChange);

      // Unified sidebar toggle logic
      sidebarToggle.addEventListener('click', () => {
        if (mediaQuery.matches) {
          // If on mobile, toggle 'open' class
          sidebar.classList.toggle('open');
        } else {
          // If on desktop, toggle 'collapsed' class
          sidebar.classList.toggle('collapsed');
        }
      });

      // Accordion sub-menus (no change)
      hasSubmenus.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const submenu = item.nextElementSibling;
          if (submenu && submenu.classList.contains('submenu')) {
            submenu.classList.toggle('open');
            item.classList.toggle('open');
          }
        });
      });

      // Active link highlighting (no change)
      const currentPath = window.location.pathname.split('/').pop();
      navLinks.forEach(link => {
        if (link.href.split('/').pop() === currentPath) {
          link.classList.add('active');
          let parentSubmenu = link.closest('.submenu');
          if (parentSubmenu) {
            parentSubmenu.classList.add('open');
            let parentHasSubmenu = parentSubmenu.previousElementSibling;
            if (parentHasSubmenu && parentHasSubmenu.classList.contains('has-submenu')) {
              parentHasSubmenu.classList.add('open');
            }
          }
        } else {
          link.classList.remove('active');
        }
      });
    });
    
  </script>
</body>
</html>