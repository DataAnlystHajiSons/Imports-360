<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Professional Costing Sheet - Imports 360</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    .costing-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: var(--primary-color);
    }

    .costing-header {
      text-align: center;
      margin-bottom: 30px;
      padding: 25px;
      background: linear-gradient(135deg, var(--accent-color), var(--highlight-color));
      color: white;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(124, 58, 237, 0.15);
      position: relative;
      overflow: hidden;
    }

    .costing-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: rotate(45deg);
      animation: shine 3s infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .costing-header h1 {
      margin: 0 0 10px 0;
      font-size: 2.4rem;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .shipment-info {
      display: flex;
      justify-content: center;
      gap: 25px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .shipment-info-item {
      background: rgba(255, 255, 255, 0.15);
      padding: 10px 18px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.2s ease;
    }

    .shipment-info-item:hover {
      transform: translateY(-2px);
    }

    /* Dynamic Selector Section */
    .selector-section {
      background: var(--primary-color);
      border: 2px solid var(--accent-color);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(124, 58, 237, 0.1);
    }

    .selector-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .selector-header h2 {
      color: var(--text-primary-color);
      margin: 0;
      font-size: 1.3rem;
      font-weight: 700;
    }

    .selector-header i {
      color: var(--accent-color);
      font-size: 1.4rem;
    }

    .dropdown-container {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .dropdown-label {
      font-weight: 600;
      color: var(--text-primary-color);
      font-size: 1rem;
    }

    .bills-dropdown {
      padding: 12px 16px;
      border: 2px solid var(--secondary-color);
      border-radius: 10px;
      background: var(--primary-color);
      color: var(--text-primary-color);
      font-size: 1rem;
      font-weight: 500;
      min-width: 250px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .bills-dropdown:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    .bills-dropdown:hover {
      border-color: var(--highlight-color);
    }

    .view-all-btn {
      background: linear-gradient(135deg, var(--success-color), #047857);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }

    .view-all-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
    }

    /* Dynamic Content Area */
    .dynamic-content {
      background: var(--primary-color);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
    }

    .dynamic-header {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      padding: 20px 25px;
      border-bottom: 3px solid var(--accent-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .dynamic-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .dynamic-title h3 {
      margin: 0;
      color: var(--text-primary-color);
      font-size: 1.4rem;
      font-weight: 700;
    }

    .dynamic-title i {
      color: var(--accent-color);
      font-size: 1.3rem;
    }

    .record-count {
      background: var(--accent-color);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* Professional Table Styles */
    .professional-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--primary-color);
    }

    .professional-table thead {
      background: linear-gradient(135deg, var(--accent-color), var(--highlight-color));
    }

    .professional-table thead th {
      padding: 16px 20px;
      color: white;
      font-weight: 700;
      text-align: left;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }

    .professional-table tbody tr {
      transition: all 0.2s ease;
      border-bottom: 1px solid #f1f5f9;
    }

    .professional-table tbody tr:hover {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      transform: scale(1.001);
    }

    .professional-table tbody tr:last-child {
      border-bottom: none;
    }

    .professional-table tbody td {
      padding: 16px 20px;
      color: var(--text-primary-color);
      font-size: 0.95rem;
      vertical-align: middle;
    }

    .currency-cell {
      font-weight: 700;
      color: var(--success-color);
      text-align: right;
      font-family: 'Courier New', monospace;
    }

    .percentage-cell {
      font-weight: 600;
      color: var(--accent-color);
      text-align: center;
    }

    .date-cell {
      color: var(--text-secondary-color);
      font-weight: 500;
    }

    /* Summary Cards */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 25px;
      padding-top: 20px;
      border-top: 2px solid #e2e8f0;
    }

    .summary-card {
      background: linear-gradient(135deg, #f0f9ff, #e6fffa);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid var(--accent-color);
      transition: transform 0.2s ease;
    }

    .summary-card:hover {
      transform: translateY(-2px);
    }

    .summary-value {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--accent-color);
      margin-bottom: 8px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .summary-label {
      font-size: 0.85rem;
      color: var(--text-secondary-color);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .no-data {
      text-align: center;
      padding: 60px 40px;
      background: var(--secondary-color);
      border-radius: 15px;
      margin: 20px;
    }

    .no-data i {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.6;
      color: var(--text-secondary-color);
    }

    .no-data h3 {
      color: var(--text-primary-color);
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .loading {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-secondary-color);
    }

    .loading i {
      font-size: 3rem;
      margin-bottom: 20px;
      animation: spin 1s linear infinite;
      color: var(--accent-color);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .print-section {
      text-align: center;
      margin: 40px 0;
      padding: 25px;
      background: var(--secondary-color);
      border-radius: 15px;
      border: 1px solid #e2e8f0;
    }

    .print-btn {
      background: linear-gradient(135deg, var(--accent-color), var(--highlight-color));
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0 12px 10px;
      box-shadow: 0 4px 10px rgba(124, 58, 237, 0.2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .print-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
    }

    .export-btn {
      background: linear-gradient(135deg, var(--success-color), #047857);
    }

    .export-btn:hover {
      box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
    }

    .back-btn {
      background: linear-gradient(135deg, var(--text-secondary-color), #475569);
    }

    .back-btn:hover {
      box-shadow: 0 6px 20px rgba(100, 116, 139, 0.4);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .costing-container {
        padding: 15px;
      }
      
      .shipment-info {
        flex-direction: column;
        gap: 12px;
      }
      
      .costing-header h1 {
        font-size: 2rem;
      }
      
      .dropdown-container {
        flex-direction: column;
        align-items: stretch;
      }
      
      .bills-dropdown {
        min-width: 100%;
      }
      
      .professional-table {
        font-size: 0.85rem;
      }
      
      .professional-table thead th,
      .professional-table tbody td {
        padding: 12px 15px;
      }
      
      .summary-cards {
        grid-template-columns: 1fr;
      }
      
      .print-btn {
        display: block;
        width: 100%;
        margin: 8px 0;
      }
    }

    /* Print Styles */
    @media print {
      body {
        background: white !important;
        color: black !important;
      }
      
      .print-section,
      .selector-section {
        display: none !important;
      }
      
      .costing-header {
        background: var(--accent-color) !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      
      .professional-table thead {
        background: var(--accent-color) !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      
      .dynamic-content {
        break-inside: avoid;
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="costing-container">
    <div class="costing-header">
      <h1><i class="fas fa-file-invoice-dollar"></i> Professional Costing Sheet</h1>
      <div class="shipment-info" id="shipment-info">
        <div class="shipment-info-item">
          <strong>Shipment:</strong> <span id="shipment-ref">Loading...</span>
        </div>
        <div class="shipment-info-item">
          <strong>Product:</strong> <span id="shipment-product">Loading...</span>
        </div>
        <div class="shipment-info-item">
          <strong>Supplier:</strong> <span id="shipment-supplier">Loading...</span>
        </div>
        <div class="shipment-info-item">
          <strong>Date:</strong> <span id="report-date">Loading...</span>
        </div>
      </div>
    </div>

    <div id="loading" class="loading">
      <i class="fas fa-spinner"></i>
      <p>Loading costing data...</p>
    </div>

    <div id="main-content" style="display: none;">
      <!-- Dynamic Bill Selector -->
      <div class="selector-section">
        <div class="selector-header">
          <i class="fas fa-list-ul"></i>
          <h2>Select Bill Type to View Details</h2>
        </div>
        <div class="dropdown-container">
          <label class="dropdown-label">Choose Bill Type:</label>
          <select id="bills-dropdown" class="bills-dropdown">
            <option value="">-- Select a Bill Type --</option>
            <option value="bank_charges">Bank Charges</option>
            <option value="fbr_duty">FBR Duties & Taxes</option>
            <option value="clearing_agent_bill">Clearing Agent Bill</option>
            <option value="agency_charges">Agency Charges</option>
            <option value="receipted_port_expense">Port Expenses</option>
            <option value="payments">Payments</option>
            <option value="duties">Custom Duties</option>
            <option value="deductions">Deductions</option>
            <option value="insurance">Insurance</option>
            <option value="freight_forwarder">Freight Forwarder</option>
            <option value="bility">Bility</option>
          </select>
          <button id="view-all-btn" class="view-all-btn">
            <i class="fas fa-eye"></i> View All Bills Summary
          </button>
        </div>
      </div>

      <!-- Dynamic Content Area -->
      <div id="dynamic-content" class="dynamic-content" style="display: none;">
        <div class="dynamic-header">
          <div class="dynamic-title">
            <i id="content-icon" class="fas fa-table"></i>
            <h3 id="content-title">Bill Details</h3>
          </div>
          <div id="record-count" class="record-count">0 Records</div>
        </div>
        
        <div id="table-container">
          <!-- Dynamic table will be inserted here -->
        </div>
        
        <div id="summary-container">
          <!-- Summary cards will be inserted here -->
        </div>
      </div>

      <!-- All Bills Summary (when View All is clicked) -->
      <div id="all-bills-summary" style="display: none;">
        <!-- All bills summary will be populated here -->
      </div>

      <div class="print-section">
        <button class="print-btn" onclick="printCosting()">
          <i class="fas fa-print"></i> Print Current View
        </button>
        <button class="print-btn export-btn" onclick="exportToExcel()">
          <i class="fas fa-file-excel"></i> Export to Excel
        </button>
        <button class="print-btn back-btn" onclick="goBack()">
          <i class="fas fa-arrow-left"></i> Back to Tracker
        </button>
      </div>
    </div>

    <div id="no-data" class="no-data" style="display: none;">
      <i class="fas fa-info-circle"></i>
      <h3>No Costing Data Available</h3>
      <p>The costing information for this shipment has not been entered yet.</p>
      <button class="print-btn back-btn" onclick="goBack()">
        <i class="fas fa-arrow-left"></i> Back to Tracker
      </button>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/+esm";
    const supabase = createClient("https://sfknzqkiqxivzcualcau.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNma256cWtpcXhpdnpjdWFsY2F1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTU0ODksImV4cCI6MjA3MjM3MTQ4OX0.JKjOS9NRdbVH1UanfqmBeHmMSnlWlZtDr-5LdKw5YaA");

    const urlParams = new URLSearchParams(window.location.search);
    const shipmentId = urlParams.get("id");
    let allBillsData = {};

    // Bill type configurations
    const BILL_CONFIGS = {
      bank_charges: {
        title: 'Bank Charges',
        icon: 'fas fa-university',
        table: 'bank_charges',
        relations: `
          *,
          lc_opening (*),
          issuance (*),
          amendment (*),
          final_payment (*),
          bank_charge_documents (*)
        `,
        columns: [
          { key: 'created_at', label: 'Date', type: 'date' },
          { key: 'lc_opening_total', label: 'LC Opening', type: 'currency' },
          { key: 'issuance_total', label: 'Issuance', type: 'currency' },
          { key: 'amendment_total', label: 'Amendment', type: 'currency' },
          { key: 'final_payment_total', label: 'Final Payment', type: 'currency' },
          { key: 'grand_total', label: 'Total', type: 'currency' }
        ]
      },
      fbr_duty: {
        title: 'FBR Duties & Taxes',
        icon: 'fas fa-receipt',
        table: 'fbr_duty',
        columns: [
          { key: 'created_at', label: 'Date', type: 'date' },
          { key: 'declared_value', label: 'Declared Value', type: 'currency' },
          { key: 'access_value', label: 'Access Value', type: 'currency' },
          { key: 'custom_duty_amount', label: 'Custom Duty', type: 'currency' },
          { key: 'additional_custom_duty_amount', label: 'Additional CD', type: 'currency' },
          { key: 'sales_tax_amount', label: 'Sales Tax', type: 'currency' },
          { key: 'income_tax_amount', label: 'Income Tax', type: 'currency' },
          { key: 'total_duties', label: 'Total Duties', type: 'currency' }
        ]
      },
      clearing_agent_bill: {
        title: 'Clearing Agent Bill',
        icon: 'fas fa-user-shield',
        table: 'clearing_agent_bill',
        columns: [
          { key: 'bill_no', label: 'Bill No.', type: 'text' },
          { key: 'invoice_no', label: 'Invoice No.', type: 'text' },
          { key: 'total_clearing_agent_value', label: 'CA Value', type: 'currency' },
          { key: 'total_expense_shipment_value', label: 'Expense Value', type: 'currency' },
          { key: 'total_bill', label: 'Total Bill', type: 'currency' },
          { key: 'duties', label: 'Duties', type: 'currency' },
          { key: 'net_payable', label: 'Net Payable', type: 'currency' }
        ]
      },
      agency_charges: {
        title: 'Agency Charges',
        icon: 'fas fa-truck',
        table: 'agency_charges',
        relations: '*, clearing_agent_bill!inner(*)',
        columns: [
          { key: 'weboc_token_value', label: 'WEBOC Token', type: 'currency' },
          { key: 'transport_charges_value', label: 'Transport', type: 'currency' },
          { key: 'godown_value', label: 'Godown', type: 'currency' },
          { key: 'sales_tax_value', label: 'Sales Tax', type: 'currency' },
          { key: 'sub_total_services_charges_value', label: 'Sub Total', type: 'currency' }
        ]
      },
      receipted_port_expense: {
        title: 'Port Expenses',
        icon: 'fas fa-anchor',
        table: 'receipted_port_expense',
        relations: '*, clearing_agent_bill!inner(*)',
        columns: [
          { key: 'detention_value', label: 'Detention', type: 'currency' },
          { key: 'demmurage_value', label: 'Demmurage', type: 'currency' },
          { key: 'handling_charges_value', label: 'Handling', type: 'currency' },
          { key: 'port_charges_value', label: 'Port Charges', type: 'currency' },
          { key: 'terminal_charges_value', label: 'Terminal', type: 'currency' },
          { key: 'container_charges_value', label: 'Container', type: 'currency' }
        ]
      },
      payments: {
        title: 'Payments',
        icon: 'fas fa-credit-card',
        table: 'payments',
        relations: '*, clearing_agent_bill!inner(*)',
        columns: [
          { key: 'cd_value', label: 'CD Value', type: 'currency' },
          { key: 'pra_or_ecs_value', label: 'PRA/ECS', type: 'currency' },
          { key: 'single_decleration_value', label: 'Single Declaration', type: 'currency' },
          { key: 'created_at', label: 'Date', type: 'date' }
        ]
      },
      duties: {
        title: 'Custom Duties',
        icon: 'fas fa-coins',
        table: 'duties',
        relations: '*, clearing_agent_bill!inner(*)',
        columns: [
          { key: 'custom_duty_value', label: 'Custom Duty', type: 'currency' },
          { key: 'acd_value', label: 'ACD', type: 'currency' },
          { key: 'sales_tax_value', label: 'Sales Tax', type: 'currency' },
          { key: 'income_tax_value', label: 'Income Tax', type: 'currency' },
          { key: 'excise_duty_value', label: 'Excise Duty', type: 'currency' }
        ]
      },
      deductions: {
        title: 'Deductions',
        icon: 'fas fa-minus-circle',
        table: 'deductions',
        relations: '*, clearing_agent_bill!inner(*)',
        columns: [
          { key: 'wht_value', label: 'WHT Value', type: 'currency' },
          { key: 'wht_accessed_perc', label: 'WHT %', type: 'percentage' },
          { key: 'created_at', label: 'Date', type: 'date' }
        ]
      },
      insurance: {
        title: 'Insurance',
        icon: 'fas fa-shield-alt',
        table: 'insurance',
        columns: [
          { key: 'insurance_amount', label: 'Amount', type: 'currency' },
          { key: 'premium_rate', label: 'Premium Rate', type: 'percentage' },
          { key: 'premium_amount', label: 'Premium', type: 'currency' },
          { key: 'policy_number', label: 'Policy No.', type: 'text' },
          { key: 'coverage_start', label: 'Coverage Start', type: 'date' },
          { key: 'coverage_end', label: 'Coverage End', type: 'date' }
        ]
      },
      freight_forwarder: {
        title: 'Freight Forwarder',
        icon: 'fas fa-shipping-fast',
        table: 'freight_forwarder',
        columns: [
          { key: 'freight_charges', label: 'Freight Charges', type: 'currency' },
          { key: 'documentation_fee', label: 'Documentation', type: 'currency' },
          { key: 'handling_charges', label: 'Handling', type: 'currency' },
          { key: 'total_charges', label: 'Total', type: 'currency' },
          { key: 'service_date', label: 'Service Date', type: 'date' }
        ]
      },
      bility: {
        title: 'Bility',
        icon: 'fas fa-file-contract',
        table: 'bility',
        columns: [
          { key: 'bility_amount', label: 'Amount', type: 'currency' },
          { key: 'bility_rate', label: 'Rate', type: 'percentage' },
          { key: 'total_amount', label: 'Total', type: 'currency' },
          { key: 'created_at', label: 'Date', type: 'date' }
        ]
      }
    };

    function formatCurrency(value) {
      if (!value || isNaN(value)) return 'N/A';
      return new Intl.NumberFormat('en-PK', {
        style: 'currency',
        currency: 'PKR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      }).format(value);
    }

    function formatPercentage(value) {
      if (!value || isNaN(value)) return 'N/A';
      return `${value}%`;
    }

    function formatDate(value) {
      if (!value) return 'N/A';
      return new Date(value).toLocaleDateString('en-PK');
    }

    function formatValue(value, type) {
      switch (type) {
        case 'currency':
          return formatCurrency(value);
        case 'percentage':
          return formatPercentage(value);
        case 'date':
          return formatDate(value);
        default:
          return value || 'N/A';
      }
    }

    async function loadShipmentInfo() {
      try {
        const { data, error } = await supabase
          .from('shipment')
          .select(`
            *,
            shipment_products (
              quantity,
              unit,
              product_variety (
                product_name,
                variety_name,
                supplier (name)
              )
            )
          `)
          .eq('id', shipmentId)
          .single();

        if (error) throw error;

        document.getElementById('shipment-ref').textContent = data.reference_code || 'N/A';
        document.getElementById('report-date').textContent = new Date().toLocaleDateString('en-PK');
        
        if (data.shipment_products && data.shipment_products.length > 0) {
          const firstProduct = data.shipment_products[0];
          document.getElementById('shipment-product').textContent = 
            `${firstProduct.product_variety.product_name} - ${firstProduct.product_variety.variety_name}`;
          document.getElementById('shipment-supplier').textContent = 
            firstProduct.product_variety.supplier.name;
        }
      } catch (error) {
        console.error('Error loading shipment info:', error);
      }
    }

    async function loadBillData(billType) {
      const config = BILL_CONFIGS[billType];
      if (!config) return null;

      try {
        let query = supabase.from(config.table);
        
        if (config.relations) {
          query = query.select(config.relations);
        } else {
          query = query.select('*');
        }

        // Add shipment filter based on table structure
        if (billType === 'agency_charges' || billType === 'receipted_port_expense' || 
            billType === 'payments' || billType === 'duties' || billType === 'deductions') {
          // These tables link through clearing_agent_bill
          const { data: cabData } = await supabase
            .from('clearing_agent_bill')
            .select('id')
            .eq('shipment_id', shipmentId)
            .single();
          
          if (cabData) {
            query = query.eq('clearing_agent_bill_id', cabData.id);
          } else {
            return null;
          }
        } else {
          query = query.eq('shipment_id', shipmentId);
        }

        const { data, error } = await query;
        if (error) throw error;

        return data;
      } catch (error) {
        console.error(`Error loading ${billType} data:`, error);
        return null;
      }
    }

    function calculateBankChargesTotal(data) {
      if (!data || data.length === 0) return data;
      
      return data.map(item => {
        let lcTotal = 0, issuanceTotal = 0, amendmentTotal = 0, finalPaymentTotal = 0;
        
        if (item.lc_opening && item.lc_opening.length > 0) {
          const lc = item.lc_opening[0];
          lcTotal = (lc.lc_opening_charges_amount || 0) + (lc.fed_amount || 0);
        }
        
        if (item.issuance && item.issuance.length > 0) {
          const issuance = item.issuance[0];
          issuanceTotal = (issuance.issuance_charges_amount || 0) + (issuance.fed_amount || 0);
        }
        
        if (item.amendment && item.amendment.length > 0) {
          const amendment = item.amendment[0];
          amendmentTotal = (amendment.amendment_charges_amount || 0) + (amendment.fed_amount || 0);
        }
        
        if (item.final_payment && item.final_payment.length > 0) {
          const finalPayment = item.final_payment[0];
          finalPaymentTotal = (finalPayment.services_charges_amount || 0) + (finalPayment.fed_amount || 0);
        }
        
        return {
          ...item,
          lc_opening_total: lcTotal,
          issuance_total: issuanceTotal,
          amendment_total: amendmentTotal,
          final_payment_total: finalPaymentTotal,
          grand_total: lcTotal + issuanceTotal + amendmentTotal + finalPaymentTotal
        };
      });
    }

    function renderTable(billType, data) {
      const config = BILL_CONFIGS[billType];
      if (!config || !data || data.length === 0) {
        return '<div class="no-data"><i class="fas fa-info-circle"></i><h3>No Data Available</h3><p>No records found for this bill type.</p></div>';
      }

      // Special processing for bank charges
      if (billType === 'bank_charges') {
        data = calculateBankChargesTotal(data);
      }

      let html = '<table class="professional-table"><thead><tr>';
      
      // Add row number column
      html += '<th>#</th>';
      
      // Add configured columns
      config.columns.forEach(col => {
        html += `<th>${col.label}</th>`;
      });
      
      html += '</tr></thead><tbody>';

      data.forEach((row, index) => {
        html += '<tr>';
        html += `<td><strong>${index + 1}</strong></td>`;
        
        config.columns.forEach(col => {
          const value = row[col.key];
          const formattedValue = formatValue(value, col.type);
          
          let cellClass = '';
          if (col.type === 'currency') cellClass = 'currency-cell';
          else if (col.type === 'percentage') cellClass = 'percentage-cell';
          else if (col.type === 'date') cellClass = 'date-cell';
          
          html += `<td class="${cellClass}">${formattedValue}</td>`;
        });
        
        html += '</tr>';
      });

      html += '</tbody></table>';
      return html;
    }

    function calculateSummary(billType, data) {
      if (!data || data.length === 0) return null;

      const config = BILL_CONFIGS[billType];
      const currencyColumns = config.columns.filter(col => col.type === 'currency');
      
      if (currencyColumns.length === 0) return null;

      const summary = {};
      let totalAmount = 0;

      currencyColumns.forEach(col => {
        let sum = 0;
        data.forEach(row => {
          const value = parseFloat(row[col.key]) || 0;
          sum += value;
        });
        summary[col.label] = sum;
        totalAmount += sum;
      });

      return {
        items: summary,
        total: totalAmount,
        recordCount: data.length
      };
    }

    function renderSummaryCards(summary) {
      if (!summary) return '';

      let html = '<div class="summary-cards">';
      
      Object.entries(summary.items).forEach(([label, value]) => {
        html += `
          <div class="summary-card">
            <div class="summary-value">${formatCurrency(value)}</div>
            <div class="summary-label">${label}</div>
          </div>
        `;
      });
      
      // Add total card
      html += `
        <div class="summary-card" style="border-color: var(--success-color);">
          <div class="summary-value" style="color: var(--success-color);">${formatCurrency(summary.total)}</div>
          <div class="summary-label">Grand Total</div>
        </div>
      `;
      
      html += '</div>';
      return html;
    }

    async function displayBillData(billType) {
      const config = BILL_CONFIGS[billType];
      if (!config) return;

      // Show loading
      document.getElementById('dynamic-content').style.display = 'block';
      document.getElementById('content-icon').className = config.icon;
      document.getElementById('content-title').textContent = config.title;
      document.getElementById('record-count').textContent = 'Loading...';
      document.getElementById('table-container').innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Loading data...</p></div>';
      document.getElementById('summary-container').innerHTML = '';

      // Load data
      const data = await loadBillData(billType);
      
      if (!data || data.length === 0) {
        document.getElementById('record-count').textContent = '0 Records';
        document.getElementById('table-container').innerHTML = '<div class="no-data"><i class="fas fa-info-circle"></i><h3>No Data Available</h3><p>No records found for this bill type.</p></div>';
        return;
      }

      // Update record count
      document.getElementById('record-count').textContent = `${data.length} Record${data.length !== 1 ? 's' : ''}`;

      // Render table
      document.getElementById('table-container').innerHTML = renderTable(billType, data);

      // Render summary
      const summary = calculateSummary(billType, data);
      if (summary) {
        document.getElementById('summary-container').innerHTML = renderSummaryCards(summary);
      }

      // Store data for potential export
      allBillsData[billType] = data;
    }

    async function showAllBillsSummary() {
      document.getElementById('dynamic-content').style.display = 'none';
      document.getElementById('all-bills-summary').style.display = 'block';
      
      let html = '<div class="dynamic-content"><div class="dynamic-header"><div class="dynamic-title"><i class="fas fa-chart-bar"></i><h3>All Bills Summary</h3></div></div>';
      
      // Load all bill types
      const promises = Object.keys(BILL_CONFIGS).map(async (billType) => {
        const data = await loadBillData(billType);
        const config = BILL_CONFIGS[billType];
        const summary = calculateSummary(billType, data);
        
        return {
          billType,
          config,
          data,
          summary,
          recordCount: data ? data.length : 0
        };
      });

      const results = await Promise.all(promises);
      
      html += '<div style="padding: 25px;"><div class="summary-cards">';
      
      let grandTotal = 0;
      results.forEach(result => {
        if (result.summary && result.summary.total > 0) {
          grandTotal += result.summary.total;
          html += `
            <div class="summary-card">
              <div class="summary-value">${formatCurrency(result.summary.total)}</div>
              <div class="summary-label">${result.config.title}</div>
              <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 5px;">${result.recordCount} records</div>
            </div>
          `;
        }
      });
      
      html += `
        <div class="summary-card" style="border-color: var(--accent-color); border-width: 3px;">
          <div class="summary-value" style="color: var(--accent-color); font-size: 2.2rem;">${formatCurrency(grandTotal)}</div>
          <div class="summary-label">TOTAL COST</div>
        </div>
      `;
      
      html += '</div></div></div>';
      
      document.getElementById('all-bills-summary').innerHTML = html;
    }

    async function initializePage() {
      if (!shipmentId) {
        showNoData();
        return;
      }

      try {
        await loadShipmentInfo();
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';

        // Set up event listeners
        document.getElementById('bills-dropdown').addEventListener('change', (e) => {
          const billType = e.target.value;
          if (billType) {
            document.getElementById('all-bills-summary').style.display = 'none';
            displayBillData(billType);
          } else {
            document.getElementById('dynamic-content').style.display = 'none';
            document.getElementById('all-bills-summary').style.display = 'none';
          }
        });

        document.getElementById('view-all-btn').addEventListener('click', () => {
          document.getElementById('bills-dropdown').value = '';
          showAllBillsSummary();
        });

      } catch (error) {
        console.error('Error initializing page:', error);
        showNoData();
      }
    }

    function showNoData() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('no-data').style.display = 'block';
    }

    function printCosting() {
      window.print();
    }

    function exportToExcel() {
      // Implement Excel export functionality
      alert('Excel export functionality will be implemented here');
    }

    function goBack() {
      if (shipmentId) {
        window.location.href = `shipment_tracker.html?id=${shipmentId}`;
      } else {
        window.history.back();
      }
    }

    // Make functions globally available
    window.printCosting = printCosting;
    window.exportToExcel = exportToExcel;
    window.goBack = goBack;

    // Initialize page
    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>